window.xsg=window.xsg||{},function(e,t){var n=[];e("script[data-xtemplate-name]").each(function(t,o){n[e(o).data("xtemplate-name")]=_.template(e(o).html())});var o=Backbone.Model.extend({defaults:{id:"generic-shortcode",title:"Generic Shortcode",icon:"icon",section:"Generic",description:"A Shortcode Description",params:[]},setSelected:function(){this.collection.setSelected(this)}}),i=Backbone.Collection.extend({model:o,url:window.xsg.data.shortcodeCollectionUrl,selected:null,initialize:function(){},section:function(e){return bySection=this.filter(function(t){return t.get("section")===e}),new i(bySection)},setSelected:function(e){this.selected=e,this.trigger("new_selection")}}),a=Backbone.Model.extend({defaults:{param_name:"generic-param",heading:"Generic Control",description:"This does something",type:"Generic",default_value:"",value:null}}),s=Backbone.Collection.extend({model:a}),l=Backbone.View.extend({id:"xsgModal",className:"xsg",template:wp.template("xsgModal"),events:{"click .xsg-modal-close":"close","click .xsg-modal-toggle-advanced":"toggleAdvanced","click #btn-ok":"insertShortcode"},controls:null,initialize:function(e){this.controller=e.controller,this.listenTo(this.collection,"change:completed",this.render),this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"new_selection",this.setupControls),this.on("controls_ready",this.renderWindow),this.collection.fetch({reset:!0}),this.render()},render:function(){this.$el.html(this.template()),this.$(".xsg-modal-sidebar").append(new f({collection:this.collection}).render().$el),this.renderWindow(),this.getAdvancedState()&&this.setAdvancedState(!0),e("body").append(this.$el).css({overflow:"hidden"}),this.$el.focus(),e(document).on("focusin",function(e){this.$el[0]===e.target||this.$el.has(e.target).length||this.$el.focus()}.bind(this))},setupControls:function(){this.controls=new s(this.collection.selected.get("params")),this.trigger("controls_ready")},renderWindow:function(){null!==this.collection.selected&&this.$("#btn-ok").prop("disabled",!1),this.$(".xsg-modal-main").html(new c({collection:this.controls,shortcode:this.collection.selected}).render().$el)},close:function(t){t&&t.preventDefault(),this.collection.selected=null,this.undelegateEvents(),e(document).off("focusin",this.preserveFocus),e("body").css({overflow:"auto"}),this.remove(),this.controller.deleteModal()},toggleAdvanced:function(e){e&&e.preventDefault(),this.setAdvancedState(!this.getAdvancedState())},getAdvancedState:function(){return"undefined"!=typeof Storage?(void 0===window.localStorage["xsg-advanced-mode"]&&(window.localStorage["xsg-advanced-mode"]=!1),"true"==window.localStorage["xsg-advanced-mode"]):this.$el.hasClass("xsg-advanced-enabled")},setAdvancedState:function(e){this.$(".xsg-modal-toggle-advanced").removeClass("active"),this.$el.removeClass("xsg-advanced-enabled"),e&&(this.$(".xsg-modal-toggle-advanced").addClass("active"),this.$el.addClass("xsg-advanced-enabled")),window.localStorage["xsg-advanced-mode"]=e},insertShortcode:function(){var e={},t="";this.controls.each(function(n){var o=n.get("data"),i=n.get("param_name");void 0!==o&&""!=o&&("content"==i?t=o:e[i]=o)});var n=this.collection.selected.get("id");output="["+n,closingTag="",_(e).each(function(e,t){output+=" "+t+'="'+e+'"'}),output+="]",t&&(output+=t),(t||this.collection.selected.get("content_element"))&&(closingTag="[/"+n+"]",output+=closingTag),console.log("Inserting Shortcode: "+output),window.wp.media.editor.insert(output),this.close()}}),c=Backbone.View.extend({className:"xsg-modal-window",template:wp.template("xsgDefaultWindow"),initialize:function(e){this.shortcode=e.shortcode},render:function(){return null==this.shortcode?this.$el.html(this.template()):(this.$el.append(new d({collection:this.collection}).render().$el),this.$el.append(new w({model:this.shortcode}).render().$el)),this}}),d=Backbone.View.extend({className:"xsg-modal-controls",render:function(){return this.collection.each(function(e){this.$el.append(r.makeControl(e.get("type"),{model:e}).render().$el)},this),this}}),r=Backbone.View.extend({className:"xsg-control",template:wp.template("xsgControlText"),renderSuper:function(){return 1==this.model.get("advanced")&&this.$el.addClass("advanced"),this.$el.html(this.template(this.model.toJSON())),this},render:function(){return this.renderSuper(),this.bindInput(),this},bindInput:function(){var t=this.model;t.set("data",this.$("#param-"+t.get("param_name")).val()),this.$("#param-"+t.get("param_name")).on("change",function(){t.set("data",e(this).val())})}},{makeControl:function(e,t){var n=window.xsg.data.ControlTypes[e]?window.xsg.data.ControlTypes[e]:r;return new n(t)}}),h=r.extend(),m=r.extend({template:wp.template("xsgControlTextArea")}),u=r.extend({template:wp.template("xsgControlCheckbox"),bindInput:function(){var t=this.model;this.$("#param-"+t.get("param_name")).prop("checked")&&t.set("data",this.$("#param-"+t.get("param_name")).val()),this.$("#param-"+t.get("param_name")).on("change",function(){e(this).prop("checked")?t.set("data",e(this).val()):t.unset("data")})}}),g=r.extend({template:wp.template("xsgControlDropdown"),initialize:function(){this.model.set("selected",this.model.get("default_value")||_(this.model.get("value")).find(function(){return!0}))}}),p=r.extend({initialize:function(){p.createMediaFrame()},events:{"click a.xsg-img-control.set":"setImage","click a.xsg-img-control.remove":"removeImage"},template:wp.template("xsgControlImageUpload"),setImage:function(e){e&&e.preventDefault();var t=p.uploader;t.off("insert"),t.on("insert",function(){data=t.state().get("selection").first().toJSON(),this.$("a.xsg-img-control.set").addClass("hidden"),this.$("a.xsg-img-control.remove").removeClass("hidden"),this.$(".xsg-image-uploader").css({"background-image":"url("+data.url+")"}),this.$("input").val(data.url).change()}.bind(this)),t.open()},removeImage:function(e){e&&e.preventDefault(),this.$("a.xsg-img-control.set").removeClass("hidden"),this.$("a.xsg-img-control.remove").addClass("hidden"),this.$(".xsg-image-uploader").css({"background-image":"none"}),this.$("input").val("")}},{uploader:null,createMediaFrame:function(){null==this.uploader&&(this.uploader=wp.media({frame:"post",state:"insert",multiple:!1}))}}),v=r.extend({template:wp.template("xsgControlColorpicker"),render:function(){return this.renderSuper(),this.$(".wp-color-picker").wpColorPicker({change:this.colorChange.bind(this)}),this},colorChange:function(e,t){this.model.set("data",t.color.toString())},bindInput:function(){}});window.xsg.data.ControlTypes={textfield:h,textarea:m,textarea_html:m,dropdown:g,checkbox:u,colorpicker:v,attach_image:p};var w=Backbone.View.extend({className:"xsg-preview",template:wp.template("xsgPreview"),initialize:function(){var e=this.model.get("demos");otherDemos=[],_.chain(e).omit(window.xsg.data.activeStack).each(function(e,t){otherDemos.push({name:window.xsg.data.stackNames[t],url:e})}),this.data={activeStack:window.xsg.data.stackNames[window.xsg.data.activeStack],activeDemo:e[window.xsg.data.activeStack],otherDemos:otherDemos}},render:function(){return this.$el.html(this.template(_.extend(this.model.toJSON(),this.data))),this}}),f=Backbone.View.extend({className:"xsg-navigation",events:{"click li.xsg-nav-item a":"click"},render:function(){return _(window.xsg.data.sectionNames).each(function(e){this.$el.append("<h3>"+e+"</h3>"),this.$el.append(new x({collection:this.collection.section(e)}).render().$el)}.bind(this)),this.$el.accordion({heightStyle:"content"}),this},click:function(e){this.$("li.xsg-nav-item a").removeClass("active"),this.$(e.target).addClass("active")}}),x=Backbone.View.extend({className:"xsg-nav-section",render:function(){return this.$el.append(e("<ul></ul>")),this.collection.each(function(e){this.$("ul").append(new $({model:e}).render().$el)},this),this}}),$=Backbone.View.extend({tagName:"li",events:{click:"click"},className:"xsg-nav-item",render:function(){return this.$el.html(e('<a href="#">'+this.model.get("title")+"</a>")),this},click:function(){this.model.setSelected()}}),k=new i;k.fetch({reset:!0});var b=function(){e(document).on("click","#xsg-media-modal-button",function(){this.openModal()}.bind(this))};b.prototype.openModal=function(){void 0===this.modalView&&(this.modalView=new l({collection:k,controller:this}))},b.prototype.deleteModal=function(){this.modalView=void 0};new b;t.Controller=b}(jQuery,xsg);